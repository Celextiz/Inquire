<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Patient Records</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <style>
    body{background:#f6f8fb;font-family:Inter,system-ui,Arial;padding:18px}
    .card{max-width:920px;margin:8px auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 8px 30px rgba(11,18,32,0.06)}
    .step { display:none; }
    .step.active { display:block; }
    .steps-nav { display:flex; gap:8px; margin-bottom:12px; }
    .step-pill { padding:6px 10px;border-radius:6px;background:#e9ecef; }
    .step-pill.active { background:#0d6efd;color:#fff; }
    label{font-weight:600}
    textarea.form-control{min-height:80px;resize:vertical}
  </style>
</head>
<body>
  <div class="card">
    <h3 id="title">Patient Records</h3>
    <div class="steps-nav mb-3">
      <div class="step-pill active" data-step="0">1 Patient's Information</div>
      <div class="step-pill" data-step="1">2 Subjective Data</div>
      <div class="step-pill" data-step="2">3 Objective Data</div>
    </div>

    <form id="recordsForm" autocomplete="off">
      <!-- Step 1 -->
      <div class="step active" data-step="0">
        <h5>Patient's Information</h5>
        <div class="row g-2">
          <div class="col-md-6">
            <label>Patient's Full Name</label>
            <input id="rec_fullname" class="form-control" type="text" />
          </div>
          <div class="col-md-2">
            <label>Age</label>
            <input id="rec_age" class="form-control" type="number" min="0" />
          </div>
          <div class="col-md-4">
            <label>Sex</label><br/>
            <div class="form-check form-check-inline"><input name="rec_sex" id="rec_sex_m" class="form-check-input" type="radio" value="Male"><label class="form-check-label">Male</label></div>
            <div class="form-check form-check-inline"><input name="rec_sex" id="rec_sex_f" class="form-check-input" type="radio" value="Female"><label class="form-check-label">Female</label></div>
          </div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-md-4">
            <label>Status</label><br/>
            <div class="form-check form-check-inline"><input name="rec_status" class="form-check-input" type="radio" value="Single"><label class="form-check-label">Single</label></div>
            <div class="form-check form-check-inline"><input name="rec_status" class="form-check-input" type="radio" value="Married"><label class="form-check-label">Married</label></div>
            <div class="form-check form-check-inline"><input name="rec_status" class="form-check-input" type="radio" value="Widow/widower"><label class="form-check-label">Widow/widower</label></div>
          </div>
          <div class="col-md-8">
            <label>Address</label>
            <input id="rec_address" class="form-control" type="text" />
          </div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-md-4">
            <label>Occupation</label><input id="rec_occupation" class="form-control" type="text" />
          </div>
          <div class="col-md-4">
            <label>Handedness</label><br/>
            <div class="form-check form-check-inline"><input name="rec_handed" class="form-check-input" type="radio" value="Right"><label class="form-check-label">Right</label></div>
            <div class="form-check form-check-inline"><input name="rec_handed" class="form-check-input" type="radio" value="Left"><label class="form-check-label">Left</label></div>
          </div>
          <div class="col-md-4">
            <label>Education level</label><br/>
            <div class="form-check form-check-inline"><input name="rec_edu" class="form-check-input" type="radio" value="Can read"><label class="form-check-label">Can read</label></div>
            <div class="form-check form-check-inline"><input name="rec_edu" class="form-check-input" type="radio" value="Can write"><label class="form-check-label">Can write</label></div>
            <div class="form-check form-check-inline"><input id="rec_edu_other_radio" name="rec_edu" class="form-check-input" type="radio" value="Other"><label class="form-check-label">Other</label></div>
            <input id="rec_edu_other" class="form-control mt-1" placeholder="If other, specify" />
          </div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-md-4">
            <label>Nationality</label><input id="rec_nationality" class="form-control" type="text" />
          </div>
          <div class="col-md-4">
            <label>Referring MD</label><input id="rec_refmd" class="form-control" type="text" />
          </div>
          <div class="col-md-4">
            <label>Rehab MD</label><input id="rec_rehabmd" class="form-control" type="text" />
          </div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-md-4">
            <label>Date of referral</label><input id="rec_date_ref" class="form-control" type="date" />
          </div>
          <div class="col-md-4">
            <label>Referring Unit/Hospital</label><input id="rec_unit" class="form-control" type="text" />
          </div>
          <div class="col-md-4">
            <label>Phone Number</label><input id="rec_phone" class="form-control" type="text" />
          </div>
        </div>

        <div class="row g-2 mt-2">
          <div class="col-md-6">
            <label>Registration Number</label><input id="rec_reg" class="form-control" type="text" />
          </div>
          <div class="col-md-6">
            <label>Diagnosis</label><input id="rec_diagnosis" class="form-control" type="text" />
          </div>
        </div>
      </div>

      <!-- Step 2 -->
      <div class="step" data-step="1">
        <h5>Subjective Data</h5>

        <div class="mb-2">
          <label>Chief Complaints</label>
          <textarea id="rec_chief" class="form-control"></textarea>
        </div>

        <div class="mb-2">
          <label>History of Present Illness/Injury (HPI)</label>
          <div class="row g-2">
            <div class="col-md-4"><label>Date of onset</label><input id="rec_onset" class="form-control" type="date" /></div>
            <div class="col-md-8"><label>Mechanism of injury</label><input id="rec_mech" class="form-control" type="text" /></div>
          </div>
        </div>

        <div class="mb-2">
          <label>Past Medical History (PMHx)</label>
          <div class="row g-2">
            <div class="col-md-4"><label>Medications</label><input id="rec_meds" class="form-control" /></div>
            <div class="col-md-4"><label>Surgery</label><input id="rec_surg" class="form-control" /></div>
            <div class="col-md-4"><label>Laboratory result</label><input id="rec_lab" class="form-control" /></div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-md-4"><label>X-ray</label><input id="rec_xray" class="form-control" /></div>
            <div class="col-md-4"><label>MRE</label><input id="rec_mre" class="form-control" /></div>
            <div class="col-md-4"><label>CTSCAN</label><input id="rec_ct" class="form-control" /></div>
          </div>
          <div class="row g-2 mt-2">
            <div class="col-md-6"><label>EMG-NCV</label><input id="rec_emg" class="form-control" /></div>
            <div class="col-md-6"><label>Previous Therapy / Sessions</label><input id="rec_prevther" class="form-control" /></div>
          </div>

          <div class="mt-2">
            <label>Food and drug allergies</label><input id="rec_allergies" class="form-control" />
          </div>

          <div class="mt-2">
            <label>Heredofamilial Diseases</label>
            <textarea id="rec_heredo" class="form-control"></textarea>
          </div>

          <div class="mt-2">
            <label>Home Situation</label><input id="rec_home" class="form-control" />
          </div>

          <div class="mt-2">
            <label>Patient Goals</label><input id="rec_goals" class="form-control" />
          </div>
        </div>
      </div>

      <!-- Step 3 -->
      <div class="step" data-step="2">
        <h5>Objective Data</h5>

        <div class="mb-2">
          <label>Ocular Inspection</label>
          <div class="row g-2">
            <div class="col-md-6">
              <label>Sensorium</label><br/>
              <div class="form-check form-check-inline"><input name="rec_sensor" class="form-check-input" type="checkbox" value="Alert"><label class="form-check-label">Alert</label></div>
              <div class="form-check form-check-inline"><input name="rec_sensor" class="form-check-input" type="checkbox" value="Drowsy"><label class="form-check-label">Drowsy</label></div>
              <div class="form-check form-check-inline"><input name="rec_sensor" class="form-check-input" type="checkbox" value="Lethargic"><label class="form-check-label">Lethargic/stuporous</label></div>
              <div class="form-check form-check-inline"><input name="rec_sensor" class="form-check-input" type="checkbox" value="Semi-coma"><label class="form-check-label">Semi-coma</label></div>
              <div class="form-check form-check-inline"><input name="rec_sensor" class="form-check-input" type="checkbox" value="Coma"><label class="form-check-label">Coma</label></div>
            </div>

            <div class="col-md-6">
              <label>Body Built</label><br/>
              <div class="form-check form-check-inline"><input name="rec_built" class="form-check-input" type="radio" value="Ectomorph"><label class="form-check-label">Ectomorph</label></div>
              <div class="form-check form-check-inline"><input name="rec_built" class="form-check-input" type="radio" value="Mesomorph"><label class="form-check-label">Mesomorph</label></div>
              <div class="form-check form-check-inline"><input name="rec_built" class="form-check-input" type="radio" value="Endomorph"><label class="form-check-label">Endomorph</label></div>
            </div>
          </div>

          <div class="row g-2 mt-2">
            <div class="col-md-6">
              <label>Orientation to</label>
              <div class="form-check"><input name="rec_orient" class="form-check-input" type="checkbox" value="Person"><label class="form-check-label">Person</label></div>
              <div class="form-check"><input name="rec_orient" class="form-check-input" type="checkbox" value="Place"><label class="form-check-label">Place</label></div>
              <div class="form-check"><input name="rec_orient" class="form-check-input" type="checkbox" value="Day/Time"><label class="form-check-label">Day/Time</label> <input id="rec_orient_text" class="form-control mt-1" placeholder="If day/time, specify"/></div>
            </div>

            <div class="col-md-6">
              <label>Mobility</label><br/>
              <div class="form-check"><input name="rec_mob" class="form-check-input" type="checkbox" value="Ambulatory"><label class="form-check-label">Ambulatory</label></div>
              <div class="form-check"><input name="rec_mob" class="form-check-input" type="checkbox" value="Ambulatory with assistive device"><label class="form-check-label">Ambulatory with assistive device</label> <input id="rec_mob_device" class="form-control mt-1" placeholder="Device"/></div>
              <div class="form-check"><input name="rec_mob" class="form-check-input" type="checkbox" value="Bed bound"><label class="form-check-label">Bed bound</label></div>
              <div class="form-check"><input name="rec_mob" class="form-check-input" type="checkbox" value="Wheelchair bound"><label class="form-check-label">Wheelchair bound</label></div>
            </div>
          </div>

          <div class="row g-2 mt-2">
            <div class="col-md-12">
              <label>Other findings (edema, hematoma, scars, lesions, atrophy, contracture, deformity, wounds, masses, braces)</label>
              <textarea id="rec_findings" class="form-control"></textarea>
            </div>
          </div>
        </div>

        <div class="mt-3">
          <h6>Palpation</h6>
          <div class="row g-2">
            <div class="col-md-4"><label>Tenderness Grade</label><select id="rec_tender" class="form-select"><option value="">Choose</option><option>1</option><option>2</option><option>3</option><option>4</option><option>5</option></select></div>
            <div class="col-md-4"><label>Pitting edema</label><input id="rec_pitting" class="form-control" /></div>
            <div class="col-md-4"><label>Swelling / Spasm / Crepitus</label><input id="rec_others" class="form-control" /></div>
          </div>

          <div class="row g-2 mt-3">
            <div class="col-md-3"><label>BP</label><input id="rec_bp" class="form-control" /></div>
            <div class="col-md-3"><label>PR</label><input id="rec_pr" class="form-control" /></div>
            <div class="col-md-3"><label>RR</label><input id="rec_rr" class="form-control" /></div>
            <div class="col-md-3"><label>SPO2</label><input id="rec_spo2" class="form-control" /></div>
            <div class="col-md-3 mt-2"><label>Temperature</label><input id="rec_temp" class="form-control" /></div>
          </div>
        </div>
      </div>

      <!-- Navigation -->
      <div class="mt-3 d-flex justify-content-between">
        <div>
          <button type="button" id="backBtn" class="btn btn-outline-secondary">Back</button>
        </div>
        <div>
          <button type="button" id="nextBtn" class="btn btn-primary">Next</button>
          <button type="submit" id="saveBtn" class="btn btn-success" style="display:none">Save</button>
        </div>
      </div>
    </form>
  </div>

  <script>
    // records form script
    const STORAGE_KEY = 'patient_list_v1';
    const params = new URLSearchParams(location.search);
    const idx = params.get('idx');
    const steps = Array.from(document.querySelectorAll('.step'));
    const pills = Array.from(document.querySelectorAll('.step-pill'));
    let current = 0;

    function loadPatients(){ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : []; }
    function savePatients(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); localStorage.setItem(STORAGE_KEY + '_updated_at', Date.now()); notifyOpener(); }

    function notifyOpener(){
      try { if (window.opener && !window.opener.closed) window.opener.postMessage({ type: 'patients_sync' }, location.origin); } catch(e){}
      try { localStorage.setItem(STORAGE_KEY + '_last_action', JSON.stringify({at:Date.now()})); } catch(e){}
    }

    function showStep(n){
      steps.forEach(s => s.classList.remove('active'));
      pills.forEach(p => p.classList.remove('active'));
      const s = steps[n]; if (s) s.classList.add('active');
      const pill = pills[n]; if (pill) pill.classList.add('active');
      current = n;
      document.getElementById('backBtn').style.display = (n === 0) ? 'none': 'inline-block';
      document.getElementById('nextBtn').style.display = (n === steps.length-1) ? 'none' : 'inline-block';
      document.getElementById('saveBtn').style.display = (n === steps.length-1) ? 'inline-block' : 'none';
    }

    // read existing records for patient and populate
    function populateFromStorage(){
      if (idx == null) return;
      const list = loadPatients();
      const patient = list[Number(idx)];
      if (!patient) return;
      const r = patient.records || {};
      // Step1
      document.getElementById('rec_fullname').value = r.fullname || [patient.firstName, patient.middleName, patient.lastName].filter(Boolean).join(' ') || '';
      document.getElementById('rec_age').value = r.age || patient.age || '';
      if(r.sex){
        const s = document.querySelectorAll('input[name="rec_sex"]');
        s.forEach(i=>{ if(i.value === r.sex) i.checked = true; });
      }
      if(r.status){
        const s = document.querySelectorAll('input[name="rec_status"]');
        s.forEach(i=>{ if(i.value === r.status) i.checked = true; });
      }
      document.getElementById('rec_address').value = r.address || '';
      document.getElementById('rec_occupation').value = r.occupation || '';
      if(r.handedness){
        const s = document.querySelectorAll('input[name="rec_handed"]');
        s.forEach(i=>{ if(i.value === r.handedness) i.checked = true; });
      }
      if(r.education){
        const s = document.querySelectorAll('input[name="rec_edu"]');
        s.forEach(i=>{ if(i.value === r.education) i.checked = true; });
        if(r.education === 'Other') document.getElementById('rec_edu_other').value = r.educationOther || '';
      }
      document.getElementById('rec_nationality').value = r.nationality || '';
      document.getElementById('rec_refmd').value = r.refmd || '';
      document.getElementById('rec_rehabmd').value = r.rehabmd || '';
      if(r.dateRef) document.getElementById('rec_date_ref').value = r.dateRef;
      document.getElementById('rec_unit').value = r.unit || '';
      document.getElementById('rec_phone').value = r.phone || '';
      document.getElementById('rec_reg').value = r.regNo || '';
      document.getElementById('rec_diagnosis').value = r.diagnosis || '';

      // Step2
      document.getElementById('rec_chief').value = r.chief || '';
      if(r.onset) document.getElementById('rec_onset').value = r.onset;
      document.getElementById('rec_mech').value = r.mechanism || '';
      document.getElementById('rec_meds').value = r.meds || '';
      document.getElementById('rec_surg').value = r.surgery || '';
      document.getElementById('rec_lab').value = r.lab || '';
      document.getElementById('rec_xray').value = r.xray || '';
      document.getElementById('rec_mre').value = r.mre || '';
      document.getElementById('rec_ct').value = r.ct || '';
      document.getElementById('rec_emg').value = r.emg || '';
      document.getElementById('rec_prevther').value = r.prevther || '';
      document.getElementById('rec_allergies').value = r.allergies || '';
      document.getElementById('rec_heredo').value = r.heredo || '';
      document.getElementById('rec_home').value = r.home || '';
      document.getElementById('rec_goals').value = r.goals || '';

      // Step3
      document.getElementById('rec_findings').value = r.findings || '';
      if(r.tender) document.getElementById('rec_tender').value = r.tender;
      document.getElementById('rec_pitting').value = r.pitting || '';
      document.getElementById('rec_others').value = r.others || '';
      document.getElementById('rec_bp').value = r.bp || '';
      document.getElementById('rec_pr').value = r.pr || '';
      document.getElementById('rec_rr').value = r.rr || '';
      document.getElementById('rec_spo2').value = r.spo2 || '';
      document.getElementById('rec_temp').value = r.temp || '';
      // sensorium, built, orient, mob as arrays / radios
      if(r.sensorium && Array.isArray(r.sensorium)){
        const boxes = document.querySelectorAll('input[name="rec_sensor"]');
        boxes.forEach(b=>{ if(r.sensorium.includes(b.value)) b.checked = true; });
      }
      if(r.built) {
        const b = document.querySelectorAll('input[name="rec_built"]');
        b.forEach(i=>{ if(i.value === r.built) i.checked = true; });
      }
      if(r.orient && Array.isArray(r.orient)){
        const b = document.querySelectorAll('input[name="rec_orient"]');
        b.forEach(i=>{ if(r.orient.includes(i.value)) i.checked = true; });
        if(r.orientText) document.getElementById('rec_orient_text').value = r.orientText || '';
      }
      if(r.mob && Array.isArray(r.mob)){
        const b = document.querySelectorAll('input[name="rec_mob"]');
        b.forEach(i=>{ if(r.mob.includes(i.value)) i.checked = true; });
        if(r.mobDevice) document.getElementById('rec_mob_device').value = r.mobDevice || '';
      }
    }

    function collectFormData(){
      const getCheckedValue = (name)=>{ const c = document.querySelectorAll('input[name="'+name+'"]'); if(!c) return null; const vals=[]; c.forEach(i=>{ if(i.type==='checkbox' && i.checked) vals.push(i.value); if(i.type==='radio' && i.checked) vals.push(i.value); }); return vals.length === 0 ? null : (c[0].type==='radio' ? vals[0] : vals); };

      const records = {
        // step1
        fullname: document.getElementById('rec_fullname').value.trim(),
        age: document.getElementById('rec_age').value || '',
        sex: getCheckedValue('rec_sex'),
        status: getCheckedValue('rec_status'),
        address: document.getElementById('rec_address').value.trim(),
        occupation: document.getElementById('rec_occupation').value.trim(),
        handedness: getCheckedValue('rec_handed'),
        education: getCheckedValue('rec_edu'),
        educationOther: document.getElementById('rec_edu_other').value.trim(),
        nationality: document.getElementById('rec_nationality').value.trim(),
        refmd: document.getElementById('rec_refmd').value.trim(),
        rehabmd: document.getElementById('rec_rehabmd').value.trim(),
        dateRef: document.getElementById('rec_date_ref').value || '',
        unit: document.getElementById('rec_unit').value.trim(),
        phone: document.getElementById('rec_phone').value.trim(),
        regNo: document.getElementById('rec_reg').value.trim(),
        diagnosis: document.getElementById('rec_diagnosis').value.trim(),

        // step2
        chief: document.getElementById('rec_chief').value.trim(),
        onset: document.getElementById('rec_onset').value || '',
        mechanism: document.getElementById('rec_mech').value.trim(),
        meds: document.getElementById('rec_meds').value.trim(),
        surgery: document.getElementById('rec_surg').value.trim(),
        lab: document.getElementById('rec_lab').value.trim(),
        xray: document.getElementById('rec_xray').value.trim(),
        mre: document.getElementById('rec_mre').value.trim(),
        ct: document.getElementById('rec_ct').value.trim(),
        emg: document.getElementById('rec_emg').value.trim(),
        prevther: document.getElementById('rec_prevther').value.trim(),
        allergies: document.getElementById('rec_allergies').value.trim(),
        heredo: document.getElementById('rec_heredo').value.trim(),
        home: document.getElementById('rec_home').value.trim(),
        goals: document.getElementById('rec_goals').value.trim(),

        // step3
        sensorium: getCheckedValue('rec_sensor'),
        built: getCheckedValue('rec_built'),
        orient: getCheckedValue('rec_orient'),
        orientText: document.getElementById('rec_orient_text').value.trim(),
        mob: getCheckedValue('rec_mob'),
        mobDevice: document.getElementById('rec_mob_device').value.trim(),
        findings: document.getElementById('rec_findings').value.trim(),
        tender: document.getElementById('rec_tender').value || '',
        pitting: document.getElementById('rec_pitting').value.trim(),
        others: document.getElementById('rec_others').value.trim(),
        bp: document.getElementById('rec_bp').value.trim(),
        pr: document.getElementById('rec_pr').value.trim(),
        rr: document.getElementById('rec_rr').value.trim(),
        spo2: document.getElementById('rec_spo2').value.trim(),
        temp: document.getElementById('rec_temp').value.trim()
      };
      return records;
    }

    // navigation
    document.getElementById('nextBtn').addEventListener('click', function(){
      if(current < steps.length - 1) showStep(current + 1);
    });
    document.getElementById('backBtn').addEventListener('click', function(){
      if(current > 0) showStep(current - 1);
    });

    // save handler
    document.getElementById('recordsForm').addEventListener('submit', function(e){
      e.preventDefault();
      if(idx == null) return alert('Invalid patient index');
      const list = loadPatients();
      const i = Number(idx);
      if(!list[i]) return alert('Patient not found');
      const rec = collectFormData();
      list[i].records = rec;
      savePatients(list);
      alert('Records saved');
      // notify opener and close
      try { if(window.opener && !window.opener.closed) window.opener.postMessage({type:'patients_sync'}, location.origin); } catch(e){}
      try { window.close(); } catch(e){}
    });

    // initialize
    showStep(0);
    populateFromStorage();
  </script>
</body>
</html>