<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Add / Edit Patient</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <style>
    body{font-family:Inter,system-ui,Arial;background:#f6f8fb;padding:18px}
    .card{max-width:760px;margin:10px auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 8px 24px rgba(11,18,32,0.06)}
    label{font-weight:600}
    .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:12px}
  </style>
</head>
<body>
  <div class="card">
    <h3 id="title">Add Patient</h3>
    <form id="patientForm" autocomplete="off">
      <div class="row g-2">
        <div class="col-md-4">
          <label for="firstName" class="form-label">First Name</label>
          <input id="firstName" name="firstName" class="form-control" type="text" required />
        </div>
        <div class="col-md-4">
          <label for="middleName" class="form-label">Middle Name</label>
          <input id="middleName" name="middleName" class="form-control" type="text" />
        </div>
        <div class="col-md-4">
          <label for="lastName" class="form-label">Last Name</label>
          <input id="lastName" name="lastName" class="form-control" type="text" required />
        </div>
      </div>

      <div class="row g-2 mt-2">
        <div class="col-md-4">
          <label for="phoneNumber" class="form-label">Phone Number</label>
          <input id="phoneNumber" name="phoneNumber" class="form-control" type="text" />
        </div>
        <div class="col-md-2">
          <label for="age" class="form-label">Age</label>
          <input id="age" name="age" class="form-control" type="number" min="0" />
        </div>
        <div class="col-md-6">
          <label for="caseField" class="form-label">Latest Treatment / Case</label>
          <input id="caseField" name="caseField" class="form-control" type="text" />
        </div>
      </div>

      <div class="actions">
        <button type="button" id="cancelBtn" class="btn btn-outline-secondary">Cancel</button>
        <button type="submit" id="saveBtn" class="btn btn-primary">Add</button>
      </div>
    </form>
  </div>

  <script>
    const STORAGE_KEY = 'patient_list_v1';
    const params = new URLSearchParams(location.search);
    const editIndexParam = params.get('edit');
    const isEdit = editIndexParam != null;

    const titleEl = document.getElementById('title');
    const form = document.getElementById('patientForm');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const firstName = document.getElementById('firstName');
    const middleName = document.getElementById('middleName');
    const lastName = document.getElementById('lastName');
    const phoneNumber = document.getElementById('phoneNumber');
    const age = document.getElementById('age');
    const caseField = document.getElementById('caseField');

    function loadPatients(){ const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : []; }
    function savePatients(list){ localStorage.setItem(STORAGE_KEY, JSON.stringify(list)); localStorage.setItem(STORAGE_KEY + '_updated_at', Date.now()); notifyOpener(); }

    function notifyOpener(){
      try{
        if(window.opener && !window.opener.closed) window.opener.postMessage({ type: 'patients_sync' }, location.origin);
      } catch(e){}
      try{ localStorage.setItem(STORAGE_KEY + '_last_action', JSON.stringify({at:Date.now()})); } catch(e){}
    }

    function populateFormIfEditing(){
      if(!isEdit) return;
      const idx = Number(editIndexParam);
      const list = loadPatients();
      const p = list[idx];
      if(!p) return;
      titleEl.textContent = 'Edit Patient';
      saveBtn.textContent = 'Save';
      firstName.value = p.firstName || '';
      middleName.value = p.middleName || '';
      lastName.value = p.lastName || '';
      phoneNumber.value = p.phoneNumber || '';
      age.value = p.age != null ? p.age : '';
      caseField.value = p.case || '';
    }

    form.addEventListener('submit', function(e){
      e.preventDefault();
      const patient = {
        firstName: firstName.value.trim(),
        middleName: middleName.value.trim(),
        lastName: lastName.value.trim(),
        phoneNumber: phoneNumber.value.trim(),
        age: age.value ? Number(age.value) : '',
        case: caseField.value.trim(),
        records: (function(){ // preserve existing records if editing
          const list = loadPatients();
          if (isEdit){ const idx = Number(editIndexParam); return list[idx] && list[idx].records ? list[idx].records : null; }
          return null;
        })()
      };
      const list = loadPatients();
      if(isEdit){
        const idx = Number(editIndexParam);
        if(idx >=0 && idx < list.length) list[idx] = patient;
      } else {
        list.push(patient);
      }
      savePatients(list);
      try{ if(window.opener && !window.opener.closed) window.close(); } catch(e){}
      saveBtn.textContent = 'Saved';
      setTimeout(()=>{ try{ window.close(); } catch(e){} }, 500);
    });

    cancelBtn.addEventListener('click', function(){ try{ window.close(); } catch(e){} });

    if(isEdit) populateFormIfEditing();
  </script>
</body>
</html>